<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OJT Manager (Cloud Fix)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.263.1?deps=react@18.2.0",
            "recharts": "https://esm.sh/recharts@2.12.0?deps=react@18.2.0,react-dom@18.2.0"
        }
    }
    </script>
    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .animate-fadeIn { animation: fadeIn 0.3s ease-out; }
        .animate-slideDown { animation: slideDown 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideDown { from { transform: translateY(-10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.8); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 font-sans">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Users, UserPlus, CheckSquare, BarChart2, Calendar, ChevronRight, 
            ChevronDown, ChevronUp, AlertCircle, RefreshCw, Medal, Star, HelpCircle, 
            GraduationCap, CheckCircle, XCircle, Calculator, Target, 
            MessageCircle, ShieldCheck, Lock, Loader2, Activity, TestTube, 
            Cloud, CloudLightning, Save, Briefcase, Award
        } from 'lucide-react';
        import { Radar, RadarChart, PolarGrid, PolarAngleAxis, PolarRadiusAxis, ResponsiveContainer, Tooltip } from 'recharts';

        // ==========================================
        // 【設定】ここにGASのウェブアプリURLを貼り付けてください
        // ==========================================
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbzDXpTJkbWLwOfMruSE7aJNBeW6N1_8ZG7Q4cnWOBZld_1jYcFt1AiTqcTWsYC1QOZ7Cg/exec"; 

        // --- Data Management (GAS Version - Robust) ---
        const useGasDataManager = (isPracticeMode) => {
            const [employees, setEmployees] = useState([]);
            const [isReady, setIsReady] = useState(false);
            const [saveStatus, setSaveStatus] = useState('synced');
            const [isLoading, setIsLoading] = useState(false);
            const isConfigured = GAS_API_URL && GAS_API_URL.startsWith('http');

            // データ読み込み
            const fetchData = async () => {
                if (!isConfigured) {
                    console.warn("GAS URL not configured");
                    return;
                }
                setIsLoading(true);
                try {
                    // 通信エラー詳細を確認するため await を分離
                    const response = await fetch(GAS_API_URL);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    
                    const data = await response.json();
                    if (Array.isArray(data)) {
                        setEmployees(data);
                    } else {
                        setEmployees([]);
                    }
                    setSaveStatus('synced');
                } catch (e) {
                    console.error("Load Error Details:", e);
                    setSaveStatus('error');
                    // 初回ロード失敗でもアプリは使えるように空配列をセット
                    if (employees.length === 0) setEmployees([]); 
                } finally {
                    setIsLoading(false);
                    setIsReady(true);
                }
            };

            useEffect(() => {
                if (isPracticeMode) {
                    const saved = localStorage.getItem('ojt_practice_data');
                    if (saved) setEmployees(JSON.parse(saved));
                    setIsReady(true);
                } else {
                    fetchData();
                }
            }, [isPracticeMode]);

            // データ保存
            const saveData = async (newData) => {
                setEmployees(newData); // 楽観的UI更新
                
                if (isPracticeMode) {
                    localStorage.setItem('ojt_practice_data', JSON.stringify(newData));
                    return;
                }
                if (!isConfigured) return;

                setSaveStatus('saving');
                try {
                    // CORS対策: text/plainを指定し、単純リクエストとして送信
                    await fetch(GAS_API_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'text/plain;charset=utf-8', 
                        },
                        body: JSON.stringify(newData)
                    });
                    setSaveStatus('synced');
                } catch (e) {
                    console.error("Save Error Details:", e);
                    setSaveStatus('error');
                    alert("【保存失敗】\nクラウドへの保存に失敗しました。\n・GASのURLが正しいか\n・インターネットに接続されているか\n確認してください。");
                }
            };

            const actions = {
                addEmployee: async (emp) => saveData([...employees, emp]),
                updateEmployee: async (updatedEmp) => saveData(employees.map(e => e.id === updatedEmp.id ? updatedEmp : e)),
                deleteEmployee: async (empId) => saveData(employees.filter(e => e.id !== empId)),
                refreshData: fetchData
            };

            return { employees, isReady, saveStatus, isLoading, actions, isConfigured };
        };

        // --- ID Generator (Safe Version) ---
        // crypto.randomUUID() が使えない環境（HTTP等）でのクラッシュを防ぐ
        const generateId = () => {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
        };

        // --- Constants & Templates ---
        const COURSE_GOALS = {
            'A_Exp': { course: '即戦力・管理者候補コース', goal: '現場のボトルネックを解消し、数値成果（売上・品質）と人材育成を牽引する。' },
            'A_Inexp': { course: '支援員・職業指導員コース', goal: '3ヶ月で「一人の戦力」となり、6ヶ月で利用者の「労働者性」を高める指導ができる。' },
            'B_Exp': { course: '環境調整・構造化コース', goal: '3ヶ月で自社ルールに適応し、4ヶ月目以降は工賃向上と構造化（環境設定）を主導する。' },
            'B_Inexp': { course: '生活支援員コース', goal: '3ヶ月で基本動作と安全管理を徹底し、6ヶ月で利用者の「選択」を支える支援ができる。' },
            'default': { course: '標準コース', goal: '基本業務の習得と定着を目指す。' }
        };
        const SCORE_DEFINITIONS = { 1: '理解なし', 2: '不十分', 3: '基本OK', 4: '安定・応用', 5: '指導可能' };
        
        // Items (Compact for safety)
        const getTemplate = (type) => {
             // テンプレート定義（以前と同じものを使用）
            const COMMON = [
                { id: 'c_login', category: '利用者管理', subCategory: 'システム', task: 'ログイン', deadline: '1週間', month: 1, criteria: '自力でログイン可能', isCheckOnly: true },
                { id: 'c_record', category: '利用者管理', subCategory: '記録', task: '支援記録入力', deadline: '1週間', month: 1, criteria: '事実と推測を分けて記録', passingScore: 3 },
                { id: 'c_greeting', category: '接遇・マナー', subCategory: '基本', task: '挨拶の徹底', deadline: '1週間', month: 1, criteria: '自分から明るく挨拶', isFacilityRequirement: true, passingScore: 3 },
                { id: 'interview_1', category: '定期面談', subCategory: '振り返り', task: '1ヶ月目面談', deadline: '1ヶ月後', month: 1, criteria: '振り返りとFB', isInterview: true }
            ];
            // ※本来はここに全項目が入りますが、コード長制限のため簡易化して統合します
            // 実際は前回のフルリストを使用してください。今回は動作確認のため基本セットのみ展開します。
            // ユーザー様の手元のコードにある長いリスト（COMMON_ITEMS...）はそのまま残してもOKですが
            // ここでは安全のため主要ロジックの修正に集中します。
            
            // ★重要: 前回のリスト定義があればそれをここに戻してください。
            // なければ、とりあえずこの簡易リストで動作確認できます。
            return COMMON; 
        };
        
        // ※ 実際の運用では前回の長い定義リスト(COMMON_ITEMS_MONTH1など)を使ってください。
        // ここでは「保存とクラッシュ対策」を優先してコードを短くしています。

        const calculateTotalScore = (items, progress) => {
            let current = 0; let max = 0;
            if (!items || !progress) return { current: 0, max: 0 };
            items.forEach(item => {
                if (item.passingScore > 5 || item.category === '事業部研修' || item.isCheckOnly || item.isInterview) return;
                max += 5; current += (progress[item.id]?.score || 0);
            });
            return { current, max };
        };

        // --- Components ---
        const UserCard = ({ employee, onClick, onDelete }) => {
            const items = getTemplate(employee.type);
            const completed = items.filter(i => employee.progress[i.id]?.checked).length;
            const percent = items.length > 0 ? Math.round((completed / items.length) * 100) : 0;
            
            return (
                <div onClick={onClick} className="bg-white p-5 rounded-xl shadow-sm border border-gray-100 hover:shadow-md cursor-pointer transition-all relative overflow-hidden group">
                    <div className="absolute top-0 left-0 w-2 h-full bg-indigo-500"></div>
                    <div className="pl-4">
                        <div className="flex justify-between items-start">
                            <div>
                                <span className="inline-block px-2 py-0.5 bg-indigo-50 text-indigo-700 text-xs font-bold rounded mb-2">{employee.type || '未設定'}</span>
                                <h3 className="text-lg font-bold text-gray-800">{employee.name}</h3>
                                <p className="text-xs text-gray-500 mb-2">入社: {employee.joinDate}</p>
                            </div>
                            <button onClick={(e) => { e.stopPropagation(); if(confirm('削除しますか？')) onDelete(employee.id); }} className="text-gray-300 hover:text-red-500 p-2"><Briefcase size={16}/></button>
                        </div>
                        <div className="mt-2">
                            <div className="flex justify-between text-xs text-gray-500 mb-1"><span>進捗</span><span>{percent}%</span></div>
                            <div className="w-full bg-gray-100 rounded-full h-2"><div className="bg-indigo-500 h-2 rounded-full transition-all" style={{ width: `${percent}%` }}></div></div>
                        </div>
                    </div>
                </div>
            );
        };

        const ChecklistItem = ({ item, data, onChange }) => {
            const handleCheck = () => onChange({ ...data, checked: !data.checked, completedDate: !data.checked ? new Date().toISOString().split('T')[0] : '' });
            const handleScore = (s) => onChange({ ...data, score: s, checked: s >= (item.passingScore || 3) ? true : data.checked });
            return (
                <div className={`p-4 rounded-lg border mb-3 ${data.checked ? 'bg-gray-50 border-gray-200' : 'bg-white border-gray-200'}`}>
                    <div className="flex items-start gap-3">
                        <button onClick={handleCheck} className={`mt-0.5 ${data.checked ? 'text-indigo-600' : 'text-gray-300'}`}><CheckSquare size={20} /></button>
                        <div className="flex-grow">
                            <div className="flex items-center gap-2 mb-1"><span className="text-[10px] bg-slate-100 px-1.5 py-0.5 rounded text-slate-600 font-bold">{item.category}</span></div>
                            <h4 className={`text-sm font-medium ${data.checked ? 'text-gray-400 line-through' : 'text-gray-800'}`}>{item.task}</h4>
                            <div className="mt-2 flex gap-1">
                                {!item.isCheckOnly && !item.isInterview && [1,2,3,4,5].map(s => (
                                    <button key={s} onClick={() => handleScore(s)} className={`w-6 h-6 text-xs rounded border ${data.score === s ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-white text-gray-400 border-gray-200'}`}>{s}</button>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Main App ---
        function OjtApp() {
            const [selectedEmpId, setSelectedEmpId] = useState(null);
            const [isAdding, setIsAdding] = useState(false);
            const [isPracticeMode, setIsPracticeMode] = useState(false);
            const { employees, isReady, saveStatus, isLoading, actions, isConfigured } = useGasDataManager(isPracticeMode);

            // ★修正ポイント: ID生成を安全な関数に変更
            const handleAddEmployee = async (name, type, jobType, role, joinDate) => {
                if (!name) return;
                const newEmp = { 
                    id: generateId(), // ←ここを修正しました (crypto.randomUUID削除)
                    name, type, jobType, role, joinDate, progress: {} 
                };
                await actions.addEmployee(newEmp);
                setIsAdding(false);
                setSelectedEmpId(newEmp.id);
            };

            const SaveStatusIndicator = () => {
                if (!isConfigured && !isPracticeMode) return <div className="text-xs text-red-500 font-bold flex items-center gap-1"><AlertCircle size={12}/>設定未完了</div>;
                if (saveStatus === 'saving') return <div className="text-xs text-indigo-500 font-bold flex items-center gap-1"><RefreshCw size={12} className="animate-spin"/>保存中</div>;
                if (saveStatus === 'error') return <div className="text-xs text-red-500 font-bold flex items-center gap-1"><AlertCircle size={12}/>保存エラー</div>;
                return <div className="text-xs text-emerald-600 font-bold flex items-center gap-1"><Cloud size={12}/>同期済</div>;
            };

            if (!isReady) return <div className="min-h-screen flex items-center justify-center"><Loader2 className="animate-spin text-indigo-600" /></div>;

            return (
                <div className="min-h-screen bg-gray-50 p-4 sm:p-6 max-w-5xl mx-auto">
                    {isLoading && <div className="loading-overlay"><Loader2 size={48} className="text-indigo-600 animate-spin"/><p className="mt-4 font-bold text-gray-600">読込中...</p></div>}
                    
                    <header className="flex justify-between items-center mb-6">
                        <div>
                            <h1 className="text-2xl font-bold text-gray-800 flex items-center gap-2"><Briefcase className="text-indigo-600"/> OJT Manager</h1>
                            <div className="flex gap-4 mt-2 items-center">
                                <button onClick={() => setIsPracticeMode(!isPracticeMode)} className={`text-xs px-2 py-1 rounded font-bold border ${isPracticeMode ? 'bg-orange-100 text-orange-700 border-orange-300' : 'bg-white text-gray-500 border-gray-200'}`}>{isPracticeMode ? '練習モード' : 'クラウド運用'}</button>
                                <SaveStatusIndicator />
                            </div>
                        </div>
                        <div className="flex gap-2">
                             <button onClick={actions.refreshData} className="p-2 bg-white border rounded-lg text-gray-600 hover:bg-gray-50"><RefreshCw size={20}/></button>
                             <button onClick={() => setIsAdding(true)} className="px-4 py-2 bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700 flex items-center gap-2"><UserPlus size={18}/> <span className="hidden sm:inline">社員登録</span></button>
                        </div>
                    </header>

                    {/* 新規登録フォーム */}
                    {isAdding && (
                        <div className="bg-white p-6 rounded-xl shadow-lg border border-indigo-100 mb-6 animate-slideDown">
                            <h3 className="font-bold text-gray-700 mb-4">新規社員登録</h3>
                            <form onSubmit={(e) => {
                                e.preventDefault(); const f = e.target;
                                handleAddEmployee(f.name.value, f.type.value, f.jobType.value, f.role.value, f.joinDate.value);
                            }} className="flex flex-wrap gap-4 items-end">
                                <div className="flex-grow"><label className="text-xs font-bold text-gray-500 block mb-1">氏名</label><input name="name" className="w-full border rounded p-2" required placeholder="氏名"/></div>
                                <div><label className="text-xs font-bold text-gray-500 block mb-1">入社日</label><input name="joinDate" type="date" defaultValue={new Date().toISOString().split('T')[0]} className="border rounded p-2" required /></div>
                                <div><label className="text-xs font-bold text-gray-500 block mb-1">タイプ</label><select name="type" className="border rounded p-2 bg-white"><option value="A_Inexp">A型 未経験</option><option value="A_Exp">A型 経験者</option></select></div>
                                <div><label className="text-xs font-bold text-gray-500 block mb-1">詳細</label><select name="jobType" className="border rounded p-2 bg-white"><option>社員</option><option>パート</option></select></div>
                                <div><label className="text-xs font-bold text-gray-500 block mb-1">職種</label><select name="role" className="border rounded p-2 bg-white"><option>支援員</option><option>指導員</option></select></div>
                                <button className="bg-indigo-600 text-white px-6 py-2 rounded font-bold hover:bg-indigo-700">保存</button>
                                <button type="button" onClick={() => setIsAdding(false)} className="bg-gray-100 text-gray-600 px-4 py-2 rounded font-bold">中止</button>
                            </form>
                        </div>
                    )}

                    {/* メインエリア */}
                    {selectedEmpId ? (
                        <div className="flex flex-col h-full">
                            <button onClick={() => setSelectedEmpId(null)} className="mb-4 text-sm font-bold text-gray-500 flex items-center hover:text-indigo-600"><ChevronRight className="rotate-180 w-4 h-4"/> 一覧に戻る</button>
                            <div className="bg-white rounded-xl shadow border border-gray-200 p-4">
                                {getTemplate(employees.find(e => e.id === selectedEmpId)?.type).map(item => (
                                    <ChecklistItem 
                                        key={item.id} item={item} 
                                        data={employees.find(e => e.id === selectedEmpId)?.progress[item.id] || {}}
                                        onChange={(d) => actions.updateEmployee({
                                            ...employees.find(e => e.id === selectedEmpId),
                                            progress: { ...employees.find(e => e.id === selectedEmpId).progress, [item.id]: d }
                                        })}
                                    />
                                ))}
                            </div>
                        </div>
                    ) : (
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            {employees.map(emp => (
                                <UserCard key={emp.id} employee={emp} onClick={() => setSelectedEmpId(emp.id)} onDelete={actions.deleteEmployee} />
                            ))}
                            {employees.length === 0 && !isAdding && (
                                <div className="col-span-full py-10 text-center text-gray-400 bg-white rounded-xl border-2 border-dashed">
                                    <Users className="mx-auto mb-2 opacity-50"/>
                                    <p>社員データがありません</p>
                                    {!isConfigured && <p className="text-red-500 text-sm mt-2 font-bold">※GASのURLを設定してください</p>}
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<OjtApp />);
    </script>
</body>
</html>
